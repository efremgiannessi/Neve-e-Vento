<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Carichi NTC 2018 | Neve, Vento & Accumuli</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Range Slider (Dark Mode) */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #60A5FA; /* Blue-400 */
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563; /* Gray-600 */
            border-radius: 2px;
        }

        /* --- STILI PER IL REPORT (Generale) --- */
        /* TRUCCO: Invece di display:none, usiamo posizione assoluta fuori schermo.
           Così il DOM è renderizzato e html2pdf può vederlo, ma l'utente no. */
        #report-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 210mm; /* Larghezza A4 esatta */
            background-color: white;
            color: black;
            padding: 20mm;
            z-index: -1;
        }

        /* --- STILI DI STAMPA (Nativi - Ctrl+P) --- */
        @media print {
            /* Nascondi app */
            #app-interface, header, footer, aside, .no-print { display: none !important; }
            
            /* Mostra report e resetta posizione per la carta */
            #report-container { 
                display: block !important; 
                position: relative !important;
                left: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            @page { margin: 1.5cm; size: A4 portrait; }
            body { background-color: white !important; -webkit-print-color-adjust: exact; }
            
            /* Stili tabella stampa */
            .print-table th { background-color: #f3f4f6 !important; color: black !important; border-bottom: 2px solid #666; }
            .print-table td { border-bottom: 1px solid #ddd; }
            
            img { max-width: 100% !important; page-break-inside: avoid; }
            .chart-container { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- INTERFACCIA PRINCIPALE -->
    <div id="app-interface" class="flex flex-col min-h-screen">
        
        <!-- Header -->
        <header class="bg-gray-800 shadow-md border-b border-gray-700 z-10 sticky top-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-900/50">
                        <i class="fa-solid fa-building-shield"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white leading-none">NTC 2018 Calculator</h1>
                        <span class="text-xs text-gray-400 font-medium tracking-wider">NEVE | VENTO | ACCUMULO</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar Controls -->
            <aside class="lg:col-span-4 space-y-6">
                
                <!-- Tabs -->
                <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-1 flex">
                    <button id="tab-snow" onclick="switchTab('snow')" class="flex-1 py-2 text-sm text-center transition rounded-lg tab-active">
                        <i class="fa-regular fa-snowflake mr-2"></i>Neve
                    </button>
                    <button id="tab-wind" onclick="switchTab('wind')" class="flex-1 py-2 text-sm text-center transition rounded-lg tab-inactive">
                        <i class="fa-solid fa-wind mr-2"></i>Vento
                    </button>
                    <button id="tab-drift" onclick="switchTab('drift')" class="flex-1 py-2 text-sm text-center transition rounded-lg tab-inactive">
                        <i class="fa-solid fa-layer-group mr-2"></i>Accumulo
                    </button>
                </div>

                <!-- Snow Inputs -->
                <div id="input-snow" class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-6 space-y-5 animate-fade-in card">
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h2 class="text-lg font-bold text-white">Parametri Neve</h2>
                        <p class="text-xs text-gray-400">Rif. NTC 2018 §3.4</p>
                    </div>

                    <!-- Inputs Neve -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Zona Climatica</label>
                        <select id="snow_zone" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2.5">
                            <option value="I-alp">Zona I - Alpina</option>
                            <option value="I-med">Zona I - Mediterranea</option>
                            <option value="II">Zona II</option>
                            <option value="III">Zona III</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Altitudine (m s.l.m.)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="snow_alt_slider" min="0" max="1500" value="200" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="snow_alt" value="200" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Inclinazione (°)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="snow_angle_slider" min="0" max="80" value="15" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="snow_angle" value="15" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Coeff. Ce</label>
                            <select id="snow_ce" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                                <option value="1.0">1.0</option>
                                <option value="0.8">0.8</option>
                                <option value="1.2">1.2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Coeff. Ct</label>
                            <input type="number" id="snow_ct" value="1.0" step="0.1" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                        </div>
                    </div>

                    <!-- BUTTONS SNOW -->
                    <div class="flex gap-2 pt-2">
                        <button onclick="handleAction('snow', 'print')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-print"></i> Stampa
                        </button>
                        <button onclick="handleAction('snow', 'pdf')" id="btn-pdf-snow" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <!-- Wind Inputs -->
                <div id="input-wind" class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-6 space-y-5 hidden card">
                    <div class="border-l-4 border-teal-500 pl-4">
                        <h2 class="text-lg font-bold text-white">Parametri Vento</h2>
                        <p class="text-xs text-gray-400">Rif. NTC 2018 §3.3</p>
                    </div>
                    
                    <!-- Inputs Vento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Zona Vento</label>
                        <select id="wind_zone" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block p-2.5">
                            <option value="1">Zona 1</option>
                            <option value="2">Zona 2</option>
                            <option value="3">Zona 3</option>
                            <option value="4">Zona 4</option>
                            <option value="5">Zona 5</option>
                            <option value="6">Zona 6</option>
                            <option value="7">Zona 7</option>
                            <option value="8">Zona 8</option>
                            <option value="9">Zona 9</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Classe Rugosità</label>
                        <select id="wind_class" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                            <option value="A">A - Urbana densa</option>
                            <option value="B">B - Urbana/Sub</option>
                            <option value="C">C - Rurale</option>
                            <option value="D">D - Mare/Costiera</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Altezza Edificio (m)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="wind_z_slider" min="1" max="100" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="wind_z" value="10" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Dist. Costa (km)</label>
                            <input type="number" id="wind_dist" value="20" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Coeff. Cp</label>
                            <input type="number" id="wind_cp" value="0.8" step="0.1" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                        </div>
                    </div>

                    <!-- BUTTONS WIND -->
                    <div class="flex gap-2 pt-2">
                        <button onclick="handleAction('wind', 'print')" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-print"></i> Stampa
                        </button>
                        <button onclick="handleAction('wind', 'pdf')" id="btn-pdf-wind" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <!-- Drift Inputs -->
                <div id="input-drift" class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-6 space-y-5 hidden card animate-fade-in">
                    <div class="border-l-4 border-purple-500 pl-4">
                        <h2 class="text-lg font-bold text-white">Accumulo Neve</h2>
                        <p class="text-xs text-gray-400">Salto di quota (NTC §3.4.4)</p>
                    </div>
                    
                    <!-- Inputs Drift -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Database</label>
                        <select id="drift_preset" onchange="applyDriftPreset()" class="w-full bg-gray-700 border border-gray-500 text-white text-sm rounded-lg p-2.5">
                            <option value="custom">Personalizzato</option>
                            <option value="shed">Shed Industriale</option>
                            <option value="res_balcony">Balcone/Terrazzo</option>
                            <option value="warehouse">Capannone</option>
                            <option value="parapet">Parapetto</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Dislivello h (m)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="drift_h_slider" min="0.5" max="10" step="0.1" value="2" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <input type="number" id="drift_h" value="2" step="0.1" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Lunghezza b1 (m)</label>
                        <input type="number" id="drift_b1" value="10" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Peso spec. γ (kN/m³)</label>
                        <input type="number" id="drift_gamma" value="2.0" step="0.5" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                    </div>
                    
                    <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                        <p class="text-xs text-gray-400">Valore base qsk:</p>
                        <p class="text-lg font-bold text-white" id="drift_qsk_ref">-- kN/m²</p>
                    </div>

                    <!-- BUTTONS DRIFT -->
                    <div class="flex gap-2 pt-2">
                        <button onclick="handleAction('drift', 'print')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-print"></i> Stampa
                        </button>
                        <button onclick="handleAction('drift', 'pdf')" id="btn-pdf-drift" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <!-- Disclaimer -->
                <div class="bg-yellow-900/30 border-l-4 border-yellow-500 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-xs text-yellow-200">
                                Strumento indicativo. Validare con professionista.
                            </p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Results & Graphs -->
            <section class="lg:col-span-8 space-y-6">
                
                <!-- Result Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Main Result -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-t-4 border-indigo-500 card relative overflow-hidden">
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-1" id="res-label-main">Carico Neve Totale (qs)</p>
                        <div class="flex items-baseline relative z-10">
                            <h3 class="text-3xl font-bold text-white" id="main_result">0.00</h3>
                            <span class="ml-2 text-lg text-gray-400 font-medium">kN/m²</span>
                        </div>
                        <i class="fa-solid fa-calculator absolute -right-2 -bottom-4 text-8xl text-gray-700/20 z-0"></i>
                    </div>

                    <!-- Secondary Result 1 -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-t-4 border-gray-600 card">
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-1" id="res-label-sec1">Carico al Suolo (qsk)</p>
                        <div class="flex items-baseline">
                            <h3 class="text-2xl font-bold text-gray-200" id="sec_result_1">0.00</h3>
                            <span class="ml-2 text-sm text-gray-500" id="unit-sec1">kN/m²</span>
                        </div>
                    </div>

                    <!-- Secondary Result 2 -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-t-4 border-gray-600 card">
                        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-1" id="res-label-sec2">Coeff. Forma (μ1)</p>
                        <div class="flex items-baseline">
                            <h3 class="text-2xl font-bold text-gray-200" id="sec_result_2">0.8</h3>
                            <span class="ml-2 text-sm text-gray-500" id="unit-sec2">-</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Accumulo -->
                <div id="drift-stats" class="bg-gray-800 rounded-xl shadow-lg p-4 border border-purple-500/30 hidden animate-fade-in card">
                    <h4 class="text-sm font-bold text-purple-300 uppercase mb-3"><i class="fa-solid fa-chart-pie mr-2"></i>Statistiche Accumulo</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-900/50 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-400">Lunghezza (ls)</p>
                            <p class="text-lg font-semibold text-white" id="stat_ls">0 m</p>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-400">Peso Cuneo</p>
                            <p class="text-lg font-semibold text-white" id="stat_weight">0 kg/m</p>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-400">Volume Neve</p>
                            <p class="text-lg font-semibold text-white" id="stat_volume">0 m³/m</p>
                        </div>
                    </div>
                </div>

                <!-- Graphs Container -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 print-break">
                    <!-- Chart 1 -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-700 card">
                        <h3 class="text-sm font-bold text-gray-300 mb-4 flex justify-between items-center">
                            <span id="chart1_title">Variazione Carico vs Altitudine</span>
                            <i class="fa-solid fa-chart-line text-blue-400"></i>
                        </h3>
                        <div class="relative h-64 w-full">
                            <canvas id="chart1"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2 -->
                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-700 card">
                        <h3 class="text-sm font-bold text-gray-300 mb-4 flex justify-between items-center">
                            <span id="chart2_title">Coefficiente di Forma</span>
                            <i class="fa-solid fa-chart-area text-teal-400"></i>
                        </h3>
                        <div class="relative h-64 w-full">
                            <canvas id="chart2"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Data Table -->
                <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700 card">
                    <div class="px-6 py-4 border-b border-gray-700 bg-gray-700/50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-200 uppercase">Dettagli di Calcolo</h3>
                        <span class="text-xs font-mono bg-gray-900 px-2 py-1 rounded text-gray-400 border border-gray-600">NTC 2018</span>
                    </div>
                    <div class="p-6">
                        <table class="min-w-full text-sm text-left text-gray-300">
                            <tbody id="details_table">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 border-t border-gray-700 py-6 mt-auto no-print">
            <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
                &copy; 2023 - Strumento Professionale per Ingegneria Civile
            </div>
        </footer>
    </div>

    <!-- REPORT CONTAINER (Populated dynamically) -->
    <div id="report-container"></div>

    <!-- LOGIC -->
    <script>
        // --- DATA ---
        const SNOW_ZONES = {'I-alp':"Zona I - Alpina",'I-med':"Zona I - Mediterranea",'II':"Zona II",'III':"Zona III"};
        const WIND_VBO = {'1':25,'2':25,'3':27,'4':28,'5':30,'6':28,'7':28,'8':30,'9':31};
        const DRIFT_PRESETS = {'shed':{h:1.5,b1:5},'res_balcony':{h:3,b1:2},'warehouse':{h:4,b1:10},'parapet':{h:1,b1:6}};

        // --- STATE ---
        let currentTab = 'snow';
        let charts = { c1: null, c2: null };
        let globalQsk = 0;

        // --- DOM ---
        const els = {
            snowZone: document.getElementById('snow_zone'),
            snowAlt: document.getElementById('snow_alt'),
            snowAltS: document.getElementById('snow_alt_slider'),
            snowAngle: document.getElementById('snow_angle'),
            snowAngleS: document.getElementById('snow_angle_slider'),
            snowCe: document.getElementById('snow_ce'),
            snowCt: document.getElementById('snow_ct'),
            
            windZone: document.getElementById('wind_zone'),
            windClass: document.getElementById('wind_class'),
            windZ: document.getElementById('wind_z'),
            windZS: document.getElementById('wind_z_slider'),
            windDist: document.getElementById('wind_dist'),
            windCp: document.getElementById('wind_cp'),

            driftPreset: document.getElementById('drift_preset'),
            driftH: document.getElementById('drift_h'),
            driftHS: document.getElementById('drift_h_slider'),
            driftB1: document.getElementById('drift_b1'),
            driftGamma: document.getElementById('drift_gamma'),
            driftQskRef: document.getElementById('drift_qsk_ref'),
            driftStats: document.getElementById('drift-stats'),
            
            mainRes: document.getElementById('main_result'),
            secRes1: document.getElementById('sec_result_1'),
            secRes2: document.getElementById('sec_result_2'),
            unitSec1: document.getElementById('unit-sec1'),
            unitSec2: document.getElementById('unit-sec2'),
            
            detailsTable: document.getElementById('details_table')
        };

        // --- INIT ---
        function init() {
            syncInput(els.snowAlt, els.snowAltS);
            syncInput(els.snowAngle, els.snowAngleS);
            syncInput(els.windZ, els.windZS);
            syncInput(els.driftH, els.driftHS);

            [els.snowZone, els.snowAlt, els.snowAngle, els.snowCe, els.snowCt, els.snowAltS, els.snowAngleS].forEach(el => el.addEventListener('input', () => { if(currentTab==='snow') calculateSnow(); else if(currentTab==='drift') calculateDrift(); }));
            [els.windZone, els.windClass, els.windZ, els.windDist, els.windCp, els.windZS].forEach(el => el.addEventListener('input', calculateWind));
            [els.driftH, els.driftHS, els.driftB1, els.driftGamma].forEach(el => {
                el.addEventListener('input', () => { document.getElementById('drift_preset').value = 'custom'; calculateDrift(); });
            });

            calculateSnow();
        }

        function syncInput(n, r) {
            n.addEventListener('input', () => r.value = n.value);
            r.addEventListener('input', () => n.value = r.value);
        }

        function switchTab(tab) {
            currentTab = tab;
            const tabs = { snow: 'tab-snow', wind: 'tab-wind', drift: 'tab-drift' };
            const containers = { snow: 'input-snow', wind: 'input-wind', drift: 'input-drift' };

            for (const key in tabs) {
                document.getElementById(tabs[key]).className = key === tab ? "flex-1 py-2 text-sm text-center transition rounded-lg tab-active" : "flex-1 py-2 text-sm text-center transition rounded-lg tab-inactive";
                document.getElementById(containers[key]).classList.toggle('hidden', key !== tab);
            }
            if(tab === 'drift') els.driftStats.classList.remove('hidden'); else els.driftStats.classList.add('hidden');
            if (tab === 'snow') calculateSnow();
            if (tab === 'wind') calculateWind();
            if (tab === 'drift') calculateDrift();
        }

        function applyDriftPreset() {
            const val = els.driftPreset.value;
            if (val !== 'custom' && DRIFT_PRESETS[val]) {
                const p = DRIFT_PRESETS[val];
                els.driftH.value = p.h;
                els.driftHS.value = p.h;
                els.driftB1.value = p.b1;
                calculateDrift();
            }
        }

        // --- HANDLER UNIFICATO: STAMPA O PDF ---
        function handleAction(type, action) {
            const container = document.getElementById('report-container');
            const btnPdf = document.getElementById(`btn-pdf-${type}`);
            
            // 1. Costruzione HTML Report (Off-screen)
            const htmlContent = buildReportHTML(type);
            container.innerHTML = htmlContent;

            if (action === 'print') {
                // Stampa nativa: usa il CSS @media print
                // Il container è già "display: block" ma fuori schermo. 
                // Il CSS @media print lo sposterà dentro al foglio.
                // Aggiungiamo un micro-delay per essere sicuri che i grafici (img) siano renderizzati.
                setTimeout(() => {
                    window.print();
                }, 500); 

            } else if (action === 'pdf') {
                // Generazione PDF
                // Mostra stato loading
                const originalText = btnPdf.innerHTML;
                btnPdf.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generazione...';
                
                // Opzioni html2pdf
                const opt = {
                    margin: [10, 10], // mm
                    filename: `Report_NTC2018_${type}_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true }, // scale 2 per alta risoluzione
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Ritardo per assicurarsi che le immagini nel container siano pronte
                setTimeout(() => {
                    html2pdf().set(opt).from(container).save().then(() => {
                        btnPdf.innerHTML = originalText;
                    }).catch(err => {
                        console.error(err);
                        btnPdf.innerHTML = 'Errore';
                    });
                }, 500);
            }
        }

        function buildReportHTML(type) {
            const date = new Date().toLocaleDateString('it-IT');
            let chart1Img = charts['c1'] ? charts['c1'].canvas.toDataURL('image/png') : '';
            let chart2Img = charts['c2'] ? charts['c2'].canvas.toDataURL('image/png') : '';
            let title = "", content = "";

            if(type === 'snow') {
                title = "Calcolo Neve NTC 2018";
                content = `
                    <table class="print-table text-sm mb-6" style="width:100%; border-collapse:collapse;">
                        <tr><th style="text-align:left; border-bottom:2px solid #ccc; padding:5px;">Parametro</th><th style="text-align:left; border-bottom:2px solid #ccc; padding:5px;">Valore</th></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Zona</td><td style="padding:5px; border-bottom:1px solid #eee;">${SNOW_ZONES[els.snowZone.value]}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Altitudine</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.snowAlt.value} m</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Inclinazione</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.snowAngle.value}°</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Ce / Ct</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.snowCe.value} / ${els.snowCt.value}</td></tr>
                    </table>
                    <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h3 style="margin:0; font-size:1.5em; color:#1e40af;">${els.mainRes.innerText} kN/m²</h3>
                        <p style="margin:0; color:#666;">Carico Neve Totale (qs)</p>
                    </div>`;
            } else if(type === 'wind') {
                title = "Calcolo Vento NTC 2018";
                content = `
                    <table class="print-table text-sm mb-6" style="width:100%; border-collapse:collapse;">
                        <tr><th style="text-align:left; border-bottom:2px solid #ccc; padding:5px;">Parametro</th><th style="text-align:left; border-bottom:2px solid #ccc; padding:5px;">Valore</th></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Zona</td><td style="padding:5px; border-bottom:1px solid #eee;">Zona ${els.windZone.value}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Rugosità</td><td style="padding:5px; border-bottom:1px solid #eee;">Classe ${els.windClass.value}</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Altezza z</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.windZ.value} m</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Cp</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.windCp.value}</td></tr>
                    </table>
                    <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h3 style="margin:0; font-size:1.5em; color:#0f766e;">${els.mainRes.innerText} kN/m²</h3>
                        <p style="margin:0; color:#666;">Pressione Vento (p)</p>
                    </div>`;
            } else if(type === 'drift') {
                title = "Calcolo Accumulo NTC 2018";
                content = `
                    <table class="print-table text-sm mb-6" style="width:100%; border-collapse:collapse;">
                        <tr><th style="text-align:left; border-bottom:2px solid #ccc; padding:5px;">Parametro</th><th style="text-align:left; border-bottom:2px solid #ccc; padding:5px;">Valore</th></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Dislivello h</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.driftH.value} m</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Lunghezza b1</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.driftB1.value} m</td></tr>
                        <tr><td style="padding:5px; border-bottom:1px solid #eee;">Densità Neve</td><td style="padding:5px; border-bottom:1px solid #eee;">${els.driftGamma.value} kN/m³</td></tr>
                    </table>
                    <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h3 style="margin:0; font-size:1.5em; color:#6b21a8;">${els.mainRes.innerText} kN/m²</h3>
                        <p style="margin:0; color:#666;">Carico Picco Accumulo</p>
                    </div>`;
            }

            return `
                <div style="font-family:sans-serif; padding:20px;">
                    <div style="border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h1 style="margin:0; font-size:1.8em; color:#111;">${title}</h1>
                            <p style="margin:5px 0 0; color:#666; font-size:0.9em;">Generato il ${date}</p>
                        </div>
                        <div style="background:#333; color:#fff; padding:5px 10px; font-weight:bold; border-radius:4px;">NTC 2018</div>
                    </div>
                    
                    ${content}

                    <h3 style="border-bottom:1px solid #ccc; padding-bottom:5px; margin-top:30px;">Grafici Analisi</h3>
                    <div style="display:flex; gap:20px; margin-top:15px;">
                        <div style="flex:1; border:1px solid #eee; padding:10px; border-radius:5px;">
                            <img src="${chart1Img}" style="width:100%; height:auto;" />
                        </div>
                        <div style="flex:1; border:1px solid #eee; padding:10px; border-radius:5px;">
                            <img src="${chart2Img}" style="width:100%; height:auto;" />
                        </div>
                    </div>
                    <div style="margin-top:40px; border-top:1px solid #eee; padding-top:10px; text-align:center; color:#999; font-size:0.8em;">
                        Documento tecnico generato automaticamente. I valori devono essere validati da un ingegnere abilitato.
                    </div>
                </div>
            `;
        }

        // --- CALC FUNCTIONS ---
        function getQsk(zone, as) {
            as = parseFloat(as);
            if (zone === 'I-alp') return as <= 200 ? 1.50 : 1.39 * (1 + Math.pow(as / 728, 2));
            if (zone === 'I-med') return as <= 200 ? 1.50 : 1.35 * (1 + Math.pow(as / 602, 2));
            if (zone === 'II') return as <= 200 ? 1.00 : 0.85 * (1 + Math.pow(as / 481, 2));
            if (zone === 'III') return as <= 200 ? 0.60 : 0.51 * (1 + Math.pow(as / 481, 2));
            return 0;
        }

        function calculateSnow() {
            setupUI('Carico Neve Copertura (qs)', 'Carico al Suolo (qsk)', 'Coeff. Forma (μ1)', 'Variazione qsk con Altitudine', 'Variazione μ1 con Pendenza');
            const zone = els.snowZone.value;
            const as = parseFloat(els.snowAlt.value);
            const angle = parseFloat(els.snowAngle.value);
            const Ce = parseFloat(els.snowCe.value);
            const Ct = parseFloat(els.snowCt.value);
            const qsk = getQsk(zone, as);
            globalQsk = qsk;
            const mu1 = angle <= 30 ? 0.8 : (angle >= 60 ? 0.0 : 0.8 * (60 - angle) / 30);
            const qs = qsk * mu1 * Ce * Ct;
            
            els.mainRes.innerText = qs.toFixed(2);
            els.secRes1.innerText = qsk.toFixed(2);
            els.secRes2.innerText = mu1.toFixed(2);
            els.unitSec1.innerText = "kN/m²";
            els.unitSec2.innerText = "-";

            updateTable([['Zona', zone],['Altitudine', `${as} m`],['qsk', `${qsk.toFixed(2)} kN/m²`],['Inclinazione', `${angle}°`],['μ1', mu1.toFixed(2)],['Ce', Ce],['Ct', Ct],['qs', `<strong class="text-blue-400">${qs.toFixed(2)} kN/m²</strong>`] ]);

            const ctx1 = document.getElementById('chart1').getContext('2d');
            const ctx2 = document.getElementById('chart2').getContext('2d');
            const alts = [], qsks = []; for (let i = 0; i <= 1500; i += 100) { alts.push(i); qsks.push(getQsk(zone, i)); }
            const angs = [], mus = []; for (let i = 0; i <= 90; i += 5) { angs.push(i); mus.push(i <= 30 ? 0.8 : (i >= 60 ? 0.0 : 0.8 * (60 - i) / 30)); }
            renderChart('c1', ctx1, 'Altitudine', 'qsk', alts, qsks, as, qsk, '#60A5FA');
            renderChart('c2', ctx2, 'Pendenza', 'μ1', angs, mus, angle, mu1, '#2DD4BF');
        }

        function calculateWind() {
            setupUI('Pressione Vento (p)', 'Vel. Base (Vb)', 'Press. Cinetica (qb)', 'Pressione vs Altezza', 'Coeff. Esposizione Ce(z)');
            const zone = els.windZone.value;
            const rClass = els.windClass.value;
            const z = parseFloat(els.windZ.value);
            const cp = parseFloat(els.windCp.value);
            const vb = WIND_VBO[zone]; 
            const qb = 0.5 * 1.25 * Math.pow(vb, 2) / 1000;
            let kr, z0, zmin;
            if (rClass === 'A') { kr=0.23; z0=0.70; zmin=12; } else if (rClass === 'B') { kr=0.22; z0=0.30; zmin=8; } else if (rClass === 'C') { kr=0.20; z0=0.10; zmin=4; } else { kr=0.19; z0=0.05; zmin=2; }
            const getCe = (h) => { const zCalc = Math.max(h, zmin); const ln = Math.log(zCalc / z0); return Math.pow(kr, 2) * ln * (7 + ln); };
            const ce = getCe(z);
            const p = qb * ce * cp;

            els.mainRes.innerText = p.toFixed(3);
            els.secRes1.innerText = vb.toFixed(1);
            els.unitSec1.innerText = "m/s";
            els.secRes2.innerText = qb.toFixed(3);
            els.unitSec2.innerText = "kN/m²";

            updateTable([['Zona', `Zona ${zone}`],['Vb', `${vb} m/s`],['Rugosità', rClass],['Altezza z', `${z} m`],['qb', `${qb.toFixed(3)} kN/m²`],['Ce', ce.toFixed(2)],['Cp', cp],['p', `<strong class="text-teal-400">${p.toFixed(3)} kN/m²</strong>`] ]);

            const ctx1 = document.getElementById('chart1').getContext('2d');
            const ctx2 = document.getElementById('chart2').getContext('2d');
            const hs = [], ps = [], ces = []; for(let h=0; h<= Math.max(z*1.5, 20); h+=2) { let v = getCe(h==0?0.1:h); hs.push(h); ces.push(v); ps.push(qb*v*cp); }
            renderChart('c1', ctx1, 'Altezza', 'p', hs, ps, z, p, '#60A5FA', true);
            renderChart('c2', ctx2, 'Altezza', 'Ce', hs, ces, z, ce, '#2DD4BF', true);
        }

        function calculateDrift() {
            const qsk = getQsk(els.snowZone.value, els.snowAlt.value);
            els.driftQskRef.innerText = qsk.toFixed(2) + " kN/m²";
            setupUI('Carico Accumulo (picco)', 'Coeff. μ2', 'Lunghezza ls', 'Profilo Carico', 'Peso Totale');
            const h = parseFloat(els.driftH.value);
            const b1 = parseFloat(els.driftB1.value);
            const gamma = parseFloat(els.driftGamma.value);
            const ce = parseFloat(els.snowCe.value);
            const ct = parseFloat(els.snowCt.value);
            let ls = Math.min(Math.max(2 * h, 5), 15, b1);
            let mu2 = Math.max((gamma * h) / qsk, 0.8);
            const qMax = mu2 * qsk * ce * ct;
            const qFlat = 0.8 * qsk * ce * ct; 
            const weight = ((qMax + qFlat) / 2) * ls; 
            const weightKg = weight * 101.97;
            const vol = weight / gamma; 

            els.mainRes.innerText = qMax.toFixed(2);
            els.secRes1.innerText = mu2.toFixed(2);
            els.unitSec1.innerText = "-";
            els.secRes2.innerText = ls.toFixed(1);
            els.unitSec2.innerText = "m";
            document.getElementById('stat_ls').innerText = ls.toFixed(1) + " m";
            document.getElementById('stat_weight').innerText = weightKg.toFixed(0) + " kg/m";
            document.getElementById('stat_volume').innerText = vol.toFixed(2) + " m³/m";

            updateTable([['Dislivello h', `${h} m`],['Lunghezza b1', `${b1} m`],['Densità', `${gamma} kN/m³`],['qsk Base', `${qsk.toFixed(2)} kN/m²`],['ls', `${ls.toFixed(1)} m`],['μ2', `<strong class="text-purple-400">${mu2.toFixed(2)}</strong>`],['Carico Max', `${qMax.toFixed(2)} kN/m²`] ]);

            const ctx1 = document.getElementById('chart1').getContext('2d');
            const ctx2 = document.getElementById('chart2').getContext('2d');
            const dists = [], loads = [];
            for(let i=0; i<=20; i++) { let x = (b1/20)*i; dists.push(x.toFixed(1)); loads.push(x<=ls ? qMax - ((qMax-qFlat)/ls)*x : qFlat); }
            if (charts['c1']) charts['c1'].destroy();
            charts['c1'] = new Chart(ctx1, { type: 'line', data: { labels: dists, datasets: [{ label: 'Carico', data: loads, borderColor: '#A855F7', backgroundColor: 'rgba(168,85,247,0.4)', fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
            
            const hs = [], ws = []; for(let th=0.5; th<=5; th+=0.5) { hs.push(th); let t_ls = Math.min(Math.max(2*th,5),15,b1); let t_mu2 = Math.max((gamma*th)/qsk,0.8); let t_qMax=t_mu2*qsk*ce*ct; ws.push(((t_qMax+qFlat)/2)*t_ls); }
            if (charts['c2']) charts['c2'].destroy();
            charts['c2'] = new Chart(ctx2, { type: 'line', data: { labels: hs, datasets: [{ label: 'Peso', data: ws, borderColor: '#2DD4BF', backgroundColor: 'rgba(45,212,191,0.2)', fill: true }, { type: 'scatter', data: [{x:h, y:weight}], backgroundColor: '#EF4444' }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}} } });
        }

        function setupUI(mainL, sec1L, sec2L, c1T, c2T) {
            document.getElementById('res-label-main').innerText = mainL;
            document.getElementById('res-label-sec1').innerText = sec1L;
            document.getElementById('res-label-sec2').innerText = sec2L;
            document.getElementById('chart1_title').innerText = c1T;
            document.getElementById('chart2_title').innerText = c2T;
        }

        function updateTable(rows) {
            els.detailsTable.innerHTML = rows.map(r => `<tr class="border-b border-gray-700 last:border-0 hover:bg-gray-700/50"><td class="py-2 text-gray-400">${r[0]}</td><td class="py-2 text-right text-gray-200">${r[1]}</td></tr>`).join('');
        }

        function renderChart(key, ctx, lx, ly, dx, dy, cx, cy, col, fill=true) {
            if (charts[key]) charts[key].destroy();
            charts[key] = new Chart(ctx, { type: 'line', data: { labels: dx, datasets: [{ label: ly, data: dy, borderColor: col, backgroundColor: col+'33', fill: fill, borderWidth: 2, pointRadius: 0, tension: 0.3 }, { type: 'scatter', label: 'Point', data: [{x: cx, y: cy}], backgroundColor: '#EF4444', pointRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false } }, scales: { x: { title: {display: true, text: lx}, grid: {display:false} }, y: { title: {display: true, text: ly}, grid: {color: '#374151'}, beginAtZero: true } } } });
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
