<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Carichi NTC 2018 | Neve & Vento (Dark)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Range Slider (Dark Mode) */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #60A5FA; /* Blue-400 */
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563; /* Gray-600 */
            border-radius: 2px;
        }

        /* Print Styles - Force White on Print */
        @media print {
            body { background: white !important; color: black !important; }
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            .shadow-xl, .shadow-md, .shadow-lg { box-shadow: none !important; }
            .bg-gray-900 { background: white !important; }
            .bg-gray-800 { background: white !important; border: 1px solid #ddd !important; }
            .text-gray-100, .text-gray-300, .text-gray-400 { color: black !important; }
            .text-white { color: black !important; }
            .border-gray-700 { border-color: #ddd !important; }
            .card { break-inside: avoid; margin-bottom: 20px; }
            /* Invert charts for print if possible or accept they might be dark blocks */
            canvas { filter: invert(1) hue-rotate(180deg); } 
        }
        
        .tab-active {
            border-bottom: 2px solid #60A5FA;
            color: #60A5FA;
            font-weight: 600;
            background-color: rgba(96, 165, 250, 0.1);
        }
        .tab-inactive {
            color: #9CA3AF;
            border-bottom: 2px solid transparent;
        }
        .tab-inactive:hover {
            color: #E5E7EB;
            border-bottom: 2px solid #374151;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 shadow-md border-b border-gray-700 z-10 sticky top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-900/50">
                    <i class="fa-solid fa-building-shield"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white leading-none">NTC 2018 Calculator</h1>
                    <span class="text-xs text-gray-400 font-medium tracking-wider">ANALISI CARICHI NEVE E VENTO</span>
                </div>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="window.print()" class="text-gray-400 hover:text-blue-400 transition p-2" title="Stampa Report">
                    <i class="fa-solid fa-print fa-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Sidebar Controls -->
        <aside class="lg:col-span-4 space-y-6 no-print">
            
            <!-- Tabs -->
            <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-1 flex">
                <button id="tab-snow" onclick="switchTab('snow')" class="flex-1 py-2 text-sm text-center transition rounded-lg tab-active">
                    <i class="fa-regular fa-snowflake mr-2"></i>Neve
                </button>
                <button id="tab-wind" onclick="switchTab('wind')" class="flex-1 py-2 text-sm text-center transition rounded-lg tab-inactive">
                    <i class="fa-solid fa-wind mr-2"></i>Vento
                </button>
            </div>

            <!-- Snow Inputs -->
            <div id="input-snow" class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-6 space-y-5 animate-fade-in card">
                <div class="border-l-4 border-blue-500 pl-4">
                    <h2 class="text-lg font-bold text-white">Parametri Neve</h2>
                    <p class="text-xs text-gray-400">Rif. NTC 2018 §3.4</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Zona Climatica</label>
                    <select id="snow_zone" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="I-alp">Zona I - Alpina</option>
                        <option value="I-med">Zona I - Mediterranea</option>
                        <option value="II">Zona II</option>
                        <option value="III">Zona III</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500" id="zone_desc">Aosta, Belluno, Trento, Bolzano...</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Altitudine as (m s.l.m.)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="snow_alt_slider" min="0" max="1500" value="200" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <input type="number" id="snow_alt" value="200" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Inclinazione Falda α (°)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="snow_angle_slider" min="0" max="80" value="15" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <input type="number" id="snow_angle" value="15" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Coeff. Esposizione Ce</label>
                        <select id="snow_ce" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                            <option value="1.0">1.0 (Normale)</option>
                            <option value="0.8">0.8 (Ventosa)</option>
                            <option value="1.2">1.2 (Protetta)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Coeff. Termico Ct</label>
                        <input type="number" id="snow_ct" value="1.0" step="0.1" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                    </div>
                </div>
            </div>

            <!-- Wind Inputs -->
            <div id="input-wind" class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 p-6 space-y-5 hidden card">
                <div class="border-l-4 border-teal-500 pl-4">
                    <h2 class="text-lg font-bold text-white">Parametri Vento</h2>
                    <p class="text-xs text-gray-400">Rif. NTC 2018 §3.3</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Zona Vento</label>
                    <select id="wind_zone" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-teal-500 focus:border-teal-500 block p-2.5">
                        <option value="1">Zona 1 (Vb,0 = 25 m/s)</option>
                        <option value="2">Zona 2 (Vb,0 = 25 m/s)</option>
                        <option value="3">Zona 3 (Vb,0 = 27 m/s)</option>
                        <option value="4">Zona 4 (Vb,0 = 28 m/s)</option>
                        <option value="5">Zona 5 (Vb,0 = 30 m/s)</option>
                        <option value="6">Zona 6 (Vb,0 = 28 m/s)</option>
                        <option value="7">Zona 7 (Vb,0 = 28 m/s)</option>
                        <option value="8">Zona 8 (Vb,0 = 30 m/s)</option>
                        <option value="9">Zona 9 (Vb,0 = 31 m/s)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500" id="wind_zone_desc">Valle d'Aosta, Piemonte, Lombardia...</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Classe Rugosità</label>
                    <select id="wind_class" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                        <option value="A">A - Aree Urbane dense</option>
                        <option value="B">B - Aree Urbane/Suburbane</option>
                        <option value="C">C - Aree Rurali con ostacoli</option>
                        <option value="D">D - Mare/Costiera priva di ostacoli</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Altezza Edificio z (m)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="wind_z_slider" min="1" max="100" value="10" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <input type="number" id="wind_z" value="10" class="w-20 bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Distanza Costa (km)</label>
                        <input type="number" id="wind_dist" value="20" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Coeff. Press. Cp</label>
                        <input type="number" id="wind_cp" value="0.8" step="0.1" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg p-2.5">
                    </div>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="bg-yellow-900/30 border-l-4 border-yellow-500 p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-xs text-yellow-200">
                            Strumento indicativo per pre-dimensionamento. I calcoli devono essere validati da un ingegnere abilitato secondo NTC 2018.
                        </p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Results & Graphs -->
        <section class="lg:col-span-8 space-y-6">
            
            <!-- Result Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Main Result -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-t-4 border-indigo-500 card">
                    <p class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-1" id="res-label-main">Carico Neve Totale (qs)</p>
                    <div class="flex items-baseline">
                        <h3 class="text-3xl font-bold text-white" id="main_result">0.00</h3>
                        <span class="ml-2 text-lg text-gray-400 font-medium">kN/m²</span>
                    </div>
                    <div class="mt-4 text-xs text-green-400 flex items-center">
                        <i class="fa-solid fa-check-circle mr-1"></i> Calcolo aggiornato
                    </div>
                </div>

                <!-- Secondary Result 1 -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-t-4 border-gray-600 card">
                    <p class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-1" id="res-label-sec1">Carico al Suolo (qsk)</p>
                    <div class="flex items-baseline">
                        <h3 class="text-2xl font-bold text-gray-200" id="sec_result_1">0.00</h3>
                        <span class="ml-2 text-sm text-gray-500">kN/m²</span>
                    </div>
                </div>

                <!-- Secondary Result 2 -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-6 border-t-4 border-gray-600 card">
                    <p class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-1" id="res-label-sec2">Coeff. Forma (μ1)</p>
                    <div class="flex items-baseline">
                        <h3 class="text-2xl font-bold text-gray-200" id="sec_result_2">0.8</h3>
                        <span class="ml-2 text-sm text-gray-500">-</span>
                    </div>
                </div>
            </div>

            <!-- Graphs Container -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 print-break">
                <!-- Chart 1 -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-700 card">
                    <h3 class="text-sm font-bold text-gray-300 mb-4 flex justify-between items-center">
                        <span id="chart1_title">Variazione Carico vs Altitudine</span>
                        <i class="fa-solid fa-chart-line text-blue-400"></i>
                    </h3>
                    <div class="relative h-64 w-full">
                        <canvas id="chart1"></canvas>
                    </div>
                </div>

                <!-- Chart 2 -->
                <div class="bg-gray-800 rounded-xl shadow-lg p-4 border border-gray-700 card">
                    <h3 class="text-sm font-bold text-gray-300 mb-4 flex justify-between items-center">
                        <span id="chart2_title">Coefficiente di Forma</span>
                        <i class="fa-solid fa-chart-area text-teal-400"></i>
                    </h3>
                    <div class="relative h-64 w-full">
                        <canvas id="chart2"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Data Table -->
            <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700 card">
                <div class="px-6 py-4 border-b border-gray-700 bg-gray-700/50 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-gray-200 uppercase">Dettagli di Calcolo</h3>
                    <span class="text-xs font-mono bg-gray-900 px-2 py-1 rounded text-gray-400 border border-gray-600">NTC 2018</span>
                </div>
                <div class="p-6">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <tbody id="details_table">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 py-6 mt-auto no-print">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
            &copy; 2023 - Strumento Professionale per Ingegneria Civile
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- CONSTANTS & DATA ---
        
        // Snow Zone Descriptions
        const SNOW_ZONES = {
            'I-alp': "Zona I - Alpina (Aosta, Belluno, Trento, Bolzano, Sondrio, Verbano-Cusio-Ossola, Vercelli, Cuneo)",
            'I-med': "Zona I - Mediterranea (Altre province Zona I)",
            'II': "Zona II (Emilia Romagna, Toscana, Umbria, Marche, Lazio, Abruzzo, Molise, Campania, Basilicata, Calabria, Sardegna, Puglia, Sicilia, ecc.)",
            'III': "Zona III (Provincia diversa dalle precedenti)"
        };

        // Wind Zones Vb,0
        const WIND_VBO = {
            '1': 25, '2': 25, '3': 27, '4': 28, '5': 30, '6': 28, '7': 28, '8': 30, '9': 31
        };

        const WIND_ZONES_DESC = {
            '1': "Valle d'Aosta, Piemonte, Lombardia, Trentino, Veneto, Friuli (parziale)",
            '2': "Emilia Romagna",
            '3': "Toscana, Marche, Umbria, Lazio, Abruzzo, Molise, Puglia, Campania, Basilicata, Calabria (parziale)",
            '4': "Sicilia e Calabria (parziale)",
            '5': "Sardegna (parziale)",
            '6': "Zone costiere",
            '7': "Zone costiere",
            '8': "Zone costiere",
            '9': "Isole ed aree esposte"
        };

        // --- STATE ---
        let currentTab = 'snow';
        let charts = { c1: null, c2: null };

        // --- DOM ELEMENTS ---
        const els = {
            snowZone: document.getElementById('snow_zone'),
            snowAlt: document.getElementById('snow_alt'),
            snowAltS: document.getElementById('snow_alt_slider'),
            snowAngle: document.getElementById('snow_angle'),
            snowAngleS: document.getElementById('snow_angle_slider'),
            snowCe: document.getElementById('snow_ce'),
            snowCt: document.getElementById('snow_ct'),
            
            windZone: document.getElementById('wind_zone'),
            windClass: document.getElementById('wind_class'),
            windZ: document.getElementById('wind_z'),
            windZS: document.getElementById('wind_z_slider'),
            windDist: document.getElementById('wind_dist'),
            windCp: document.getElementById('wind_cp'),
            
            mainRes: document.getElementById('main_result'),
            secRes1: document.getElementById('sec_result_1'),
            secRes2: document.getElementById('sec_result_2'),
            
            detailsTable: document.getElementById('details_table'),
            
            zoneDescSnow: document.getElementById('zone_desc'),
            zoneDescWind: document.getElementById('wind_zone_desc')
        };

        // --- INITIALIZATION ---
        function init() {
            // Sync sliders and inputs
            syncInput(els.snowAlt, els.snowAltS);
            syncInput(els.snowAngle, els.snowAngleS);
            syncInput(els.windZ, els.windZS);

            // Add event listeners
            const snowInputs = [els.snowZone, els.snowAlt, els.snowAngle, els.snowCe, els.snowCt, els.snowAltS, els.snowAngleS];
            const windInputs = [els.windZone, els.windClass, els.windZ, els.windDist, els.windCp, els.windZS];

            snowInputs.forEach(el => el.addEventListener('input', calculateSnow));
            windInputs.forEach(el => el.addEventListener('input', calculateWind));

            // Initial calc
            calculateSnow();
        }

        function syncInput(numberInput, rangeInput) {
            numberInput.addEventListener('input', () => rangeInput.value = numberInput.value);
            rangeInput.addEventListener('input', () => numberInput.value = rangeInput.value);
        }

        function switchTab(tab) {
            currentTab = tab;
            const tabSnow = document.getElementById('tab-snow');
            const tabWind = document.getElementById('tab-wind');
            const containerSnow = document.getElementById('input-snow');
            const containerWind = document.getElementById('input-wind');

            if (tab === 'snow') {
                tabSnow.className = "flex-1 py-2 text-sm text-center transition rounded-lg tab-active";
                tabWind.className = "flex-1 py-2 text-sm text-center transition rounded-lg tab-inactive";
                containerSnow.classList.remove('hidden');
                containerWind.classList.add('hidden');
                calculateSnow();
            } else {
                tabSnow.className = "flex-1 py-2 text-sm text-center transition rounded-lg tab-inactive";
                tabWind.className = "flex-1 py-2 text-sm text-center transition rounded-lg tab-active";
                containerSnow.classList.add('hidden');
                containerWind.classList.remove('hidden');
                calculateWind();
            }
        }

        // --- CALCULATION LOGIC: SNOW ---
        function getQsk(zone, as) {
            as = parseFloat(as);
            if (zone === 'I-alp') {
                if (as <= 200) return 1.50;
                return 1.39 * (1 + Math.pow(as / 728, 2));
            }
            if (zone === 'I-med') {
                if (as <= 200) return 1.50;
                return 1.35 * (1 + Math.pow(as / 602, 2));
            }
            if (zone === 'II') {
                if (as <= 200) return 1.00;
                return 0.85 * (1 + Math.pow(as / 481, 2));
            }
            if (zone === 'III') {
                if (as <= 200) return 0.60;
                return 0.51 * (1 + Math.pow(as / 481, 2));
            }
            return 0;
        }

        function getMu1(angle) {
            if (angle <= 30) return 0.8;
            if (angle >= 60) return 0.0;
            // Interpolazione lineare: 0.8 a 30, 0.0 a 60
            return 0.8 * (60 - angle) / 30;
        }

        function calculateSnow() {
            // Update labels
            document.getElementById('res-label-main').innerText = "Carico Neve Copertura (qs)";
            document.getElementById('res-label-sec1').innerText = "Carico al Suolo (qsk)";
            document.getElementById('res-label-sec2').innerText = "Coeff. Forma (μ1)";
            document.getElementById('chart1_title').innerText = "Variazione qsk con Altitudine";
            document.getElementById('chart2_title').innerText = "Variazione μ1 con Pendenza";
            els.zoneDescSnow.innerText = SNOW_ZONES[els.snowZone.value];

            // Values
            const zone = els.snowZone.value;
            const as = parseFloat(els.snowAlt.value);
            const angle = parseFloat(els.snowAngle.value);
            const Ce = parseFloat(els.snowCe.value);
            const Ct = parseFloat(els.snowCt.value);

            // Calc
            const qsk = getQsk(zone, as);
            const mu1 = getMu1(angle);
            const qs = qsk * mu1 * Ce * Ct;

            // Update UI
            els.mainRes.innerText = qs.toFixed(2);
            els.secRes1.innerText = qsk.toFixed(2);
            els.secRes2.innerText = mu1.toFixed(2);

            updateTable([
                ['Zona Climatica', zone],
                ['Altitudine (as)', `${as} m`],
                ['Carico al Suolo Caratteristico (qsk)', `${qsk.toFixed(3)} kN/m²`],
                ['Pendenza Falda (α)', `${angle}°`],
                ['Coefficiente Forma (μ1)', mu1.toFixed(2)],
                ['Coefficiente Esposizione (Ce)', Ce.toFixed(1)],
                ['Coefficiente Termico (Ct)', Ct.toFixed(1)],
                ['Carico Neve Copertura (qs)', `<strong class="text-blue-400">${qs.toFixed(3)} kN/m²</strong>`]
            ]);

            // Charts
            updateSnowCharts(zone, as, angle);
        }

        function updateSnowCharts(zone, currentAs, currentAngle) {
            const ctx1 = document.getElementById('chart1').getContext('2d');
            const ctx2 = document.getElementById('chart2').getContext('2d');

            // Chart 1: Qsk vs Altitude (Range 0 - 1500m)
            const alts = [];
            const qsks = [];
            for (let i = 0; i <= 1500; i += 100) {
                alts.push(i);
                qsks.push(getQsk(zone, i));
            }

            // Chart 2: Mu1 vs Angle (0 - 90)
            const angles = [];
            const mus = [];
            for (let i = 0; i <= 90; i += 5) {
                angles.push(i);
                mus.push(getMu1(i));
            }

            renderChart('c1', ctx1, 'Altitudine (m)', 'qsk (kN/m²)', alts, qsks, currentAs, getQsk(zone, currentAs), '#60A5FA');
            renderChart('c2', ctx2, 'Pendenza (°)', 'μ1', angles, mus, currentAngle, getMu1(currentAngle), '#2DD4BF');
        }

        // --- CALCULATION LOGIC: WIND ---
        function calculateWind() {
            // Update labels
            document.getElementById('res-label-main').innerText = "Pressione del Vento (p)";
            document.getElementById('res-label-sec1').innerText = "Vel. Base (Vb)";
            document.getElementById('res-label-sec2').innerText = "Pressione Cinetica (qb)";
            document.getElementById('chart1_title').innerText = "Profilo Pressione Vento (p) vs Altezza";
            document.getElementById('chart2_title').innerText = "Coeff. Esposizione Ce(z) vs Altezza";
            els.zoneDescWind.innerText = WIND_ZONES_DESC[els.windZone.value];

            const zone = els.windZone.value;
            const rClass = els.windClass.value;
            const z = parseFloat(els.windZ.value);
            const dist = parseFloat(els.windDist.value); 
            const cp = parseFloat(els.windCp.value);
            const cd = 1.0; 

            // 1. Basic Velocity Vb
            const vb0 = WIND_VBO[zone];
            const ca = 1.0; 
            const vb = vb0 * ca; 

            // 2. Kinetic Pressure qb
            const ro = 1.25; 
            const qb = 0.5 * ro * Math.pow(vb, 2) / 1000; 

            // 3. Exposure Coefficient Ce(z)
            let kr, z0, zmin;
            switch(rClass) {
                case 'A': kr=0.23; z0=0.70; zmin=12; break; 
                case 'B': kr=0.22; z0=0.30; zmin=8; break;  
                case 'C': kr=0.20; z0=0.10; zmin=4; break;  
                case 'D': kr=0.19; z0=0.05; zmin=2; break;  
            }
            
            const ct = 1.0;

            function getCe(height) {
                const zCalc = Math.max(height, zmin);
                const ln = Math.log(zCalc / z0);
                return Math.pow(kr, 2) * ct * ln * (7 + ct * ln);
            }

            const ce = getCe(z);
            
            // 4. Final Pressure p = qb * ce * cp * cd
            const p = qb * ce * cp * cd;

            // Update UI
            els.mainRes.innerText = p.toFixed(3);
            els.secRes1.innerText = vb.toFixed(1) + " m/s";
            els.secRes2.innerText = qb.toFixed(3) + " kN/m²";

            updateTable([
                ['Zona Vento', `Zona ${zone}`],
                ['Velocità Base Rif. (Vb,0)', `${vb0} m/s`],
                ['Classe Rugosità', `Cat. ${rClass}`],
                ['Altezza Edificio (z)', `${z} m`],
                ['Pressione Cinetica Base (qb)', `${qb.toFixed(4)} kN/m²`],
                ['Coeff. Esposizione (Ce)', ce.toFixed(3)],
                ['Coeff. Pressione (Cp)', cp.toFixed(2)],
                ['Pressione Vento (p)', `<strong class="text-teal-400">${p.toFixed(3)} kN/m²</strong>`]
            ]);

            updateWindCharts(qb, cp, cd, getCe, z);
        }

        function updateWindCharts(qb, cp, cd, ceFunc, currentZ) {
            const ctx1 = document.getElementById('chart1').getContext('2d');
            const ctx2 = document.getElementById('chart2').getContext('2d');

            const heights = [];
            const pressures = [];
            const ces = [];
            
            const maxH = Math.max(Math.ceil(currentZ * 1.5), 20);

            for(let h=0; h<=maxH; h+=2) {
                let hCalc = h === 0 ? 0.1 : h;
                let ceVal = ceFunc(hCalc);
                heights.push(h);
                ces.push(ceVal);
                pressures.push(qb * ceVal * cp * cd);
            }

            renderChart('c1', ctx1, 'Altezza z (m)', 'Pressione p (kN/m²)', heights, pressures, currentZ, qb * ceFunc(currentZ) * cp * cd, '#60A5FA', true);
            renderChart('c2', ctx2, 'Altezza z (m)', 'Ce(z)', heights, ces, currentZ, ceFunc(currentZ), '#2DD4BF', true);
        }

        // --- SHARED UI FUNCTIONS ---
        function updateTable(rows) {
            const html = rows.map(r => `
                <tr class="border-b border-gray-700 last:border-0 hover:bg-gray-700/50">
                    <td class="py-2 font-medium text-gray-400">${r[0]}</td>
                    <td class="py-2 text-right text-gray-200">${r[1]}</td>
                </tr>
            `).join('');
            els.detailsTable.innerHTML = html;
        }

        function renderChart(key, ctx, labelX, labelY, dataX, dataY, currentX, currentY, color, isHorizontal = false) {
            if (charts[key]) charts[key].destroy();

            let datasets = [{
                label: labelY,
                data: dataY,
                borderColor: color,
                backgroundColor: color + '20', // transparent version
                borderWidth: 2,
                pointRadius: 0,
                fill: true,
                tension: 0.4
            }];

            datasets.push({
                label: 'Valore Attuale',
                data: [{x: currentX, y: currentY}],
                backgroundColor: '#EF4444',
                borderColor: '#1F2937', // dark border for point
                borderWidth: 2,
                pointRadius: 6,
                type: 'scatter'
            });

            Chart.defaults.color = '#9CA3AF';
            Chart.defaults.borderColor = '#374151';

            charts[key] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataX,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1F2937',
                            titleColor: '#F3F4F6',
                            bodyColor: '#D1D5DB',
                            borderColor: '#4B5563',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(3);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: labelX, color: '#9CA3AF' },
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: labelY, color: '#9CA3AF' },
                            beginAtZero: true,
                            border: { dash: [4, 4] },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>